<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1162/1162456.png">
    <title>SENTINELA V12 | COMMAND INTERFACE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
@media print {
    /* Esconde tudo o que n√£o for a √°rea da nota */
    body * {
        visibility: hidden;
    }
    /* Mostra apenas a √°rea de impress√£o e seus filhos */
    #printArea, #printArea * {
        visibility: visible;
    }
    #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
}

        
        :root { 
            --active-orange: #ff6b00; 
            --deep-orange: #e65f00;
            --gov-bg: #f8fafc;
        }
        
        body { background: var(--gov-bg); font-family: 'Inter', sans-serif; color: #334155; }
        
        .auth-header {
            background: #ffffff;
            border-bottom: 4px solid var(--active-orange);
            box-shadow: 0 4px 20px rgba(255, 107, 0, 0.15);
        }

        .v12-logo-3d {
            background: linear-gradient(145deg, var(--active-orange), var(--deep-orange));
            color: white; font-weight: 900; padding: 10px 25px;
            border-radius: 4px;
            transform: perspective(500px) rotateY(-10deg);
            box-shadow: 5px 5px 15px rgba(230, 95, 0, 0.4);
            font-size: 26px; border: 1px solid rgba(255,255,255,0.2);
        }

        .panel-3d { 
            background: #ffffff; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }
        
        .input-tactical {
            border: 2px solid #e2e8f0; padding: 14px; border-radius: 10px;
            font-weight: 700; transition: all 0.3s;
            background: #fdfdfd;
        }
        .input-tactical:focus { 
            border-color: var(--active-orange); 
            background: #fff; 
            box-shadow: 0 0 0 4px rgba(255, 107, 0, 0.1);
            outline: none; 
        }

        .terminal-log {
            background: #1e293b; color: #fb923c;
            font-family: 'JetBrains Mono', monospace; font-size: 11px;
            padding: 15px; border-radius: 12px; border: 2px solid #334155;
        }

        .btn-orange {
            background: linear-gradient(180deg, #ff8a33 0%, #ff6b00 100%);
            border-bottom: 4px solid #b34b00;
            transition: all 0.1s;
        }
        .btn-orange:active {
            transform: translateY(2px);
            border-bottom-width: 0px;
        }

        #reader { width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 20px; display: none; }

        .thermal-print-container {
            width: 80mm;
            background: white;
            padding: 10px;
            color: black;
            font-family: 'JetBrains Mono', monospace;
        }
        .ml-style-header {
            border: 4px solid black;
            text-align: center;
            font-weight: 600;
            font-size: 24px;
            padding: 5px;
            transform: skewX(-5deg);
            margin-bottom: 15px;
        }

        .dre-card { border-left: 5px solid var(--active-orange); background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        #auth-gate { position: fixed; inset: 0; background: #0f172a; z-index: 10000; display: flex; align-items: center; justify-content: center; }

        @media print { 
            .no-print { display: none !important; } 
            #print-area { display: block !important; } 
        }

        /* NOVOS ESTILOS ADICIONADOS */
        .ai-status-pulse { animation: pulse-ai 2s infinite; }
        @keyframes pulse-ai {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .prophetic-alert {
            background: linear-gradient(90deg, #0f172a 0%, #334155 100%);
            border-left: 4px solid #f97316;
        }
    </style>
</head>
<body>

    <div id="auth-gate" class="no-print">
        <div class="bg-white p-12 rounded-[40px] shadow-2xl w-[450px] text-center border-b-8 border-orange-600">
            <div class="v12-logo-3d inline-block mb-8">V12</div>
            <h2 class="text-3xl font-black text-slate-800 uppercase italic mb-2 tracking-tighter">Acesso de Autoridade</h2>
            <p class="text-slate-400 text-xs font-bold mb-10 tracking-widest uppercase">P2 H Aion</p>
            
            <div class="space-y-4">
                <input type="email" id="v12_email" placeholder="E-mail de Comando" class="input-tactical w-full">
                <input type="password" id="v12_pass" placeholder="Chave Criptogr√°fica" class="input-tactical w-full">
                <button onclick="checkV12Auth()" class="btn-orange w-full text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest text-sm">Iniciar Sincroniza√ß√£o</button>
                <p class="text-[10px] text-slate-400 mt-4 cursor-pointer hover:text-orange-500 font-bold uppercase transition-all" 
   onclick="solicitarCadastro()">
   Solicitar novo cadastro de operador
</p>
            </div>
        </div>
    </div>

    <div class="no-print">
        <header class="auth-header p-5 flex justify-between items-center px-10">
            <div class="flex items-center gap-8">
                <div class="v12-logo-3d">V12</div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter uppercase text-slate-800">S - <span class="text-orange-600">IHVH</span></h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-black bg-slate-800 text-white px-2 py-0.5 rounded">.</span>
                        <span id="network-badge" class="text-[9px] font-black bg-orange-100 text-orange-700 px-2 py-0.5 rounded italic">BUSCANDO REDE...</span>
                    </div>
                </div>
            </div>
            
            <div id="statusHw" class="bg-orange-50 px-4 py-2 rounded-lg border border-orange-200 flex items-center gap-3">
                <span class="w-3 h-3 bg-emerald-500 rounded-full animate-ping"></span>
                <span class="text-[11px] font-black uppercase text-emerald-600">Sistema Ativo</span>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto p-8 grid grid-cols-12 gap-8">
            <div class="col-span-12 lg:col-span-8 space-y-8">
                
                <div class="prophetic-alert p-4 rounded-xl flex items-center justify-between shadow-lg">
                    <div class="flex items-center gap-4">
                        <div class="bg-orange-500 p-2 rounded-lg ai-status-pulse">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest">Alinhamento Estrat√©gico</p>
                            <p id="ai-insight" class="text-white text-xs font-medium italic">An√°lise de autoridade</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[9px] text-slate-400 block uppercase font-bold">Status</span>
                        <span class="text-emerald-400 text-[10px] font-black uppercase">Mapeado</span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="dre-card shadow-sm border-l-emerald-500">
                        <span class="text-[9px] font-black text-slate-400 uppercase">Receita Bruta</span>
                        <h4 id="dre_receita" class="text-2xl font-black text-slate-800">R$ 0,00</h4>
                    </div>
                    <div class="dre-card shadow-sm border-l-red-500">
                        <span class="text-[9px] font-black text-slate-400 uppercase">Despesas</span>
                        <h4 id="dre_despesa" class="text-2xl font-black text-red-600">R$ 0,00</h4>
                    </div>
                    <div class="dre-card shadow-sm border-l-blue-500">
                        <span class="text-[9px] font-black text-slate-400 uppercase">Investimento</span>
                        <h4 id="dre_invest" class="text-2xl font-black text-blue-600">R$ 0,00</h4>
                    </div>
                </div>

                <div class="panel-3d p-10">
                    <div class="flex items-center justify-between mb-10 border-b border-slate-100 pb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-3 h-10 bg-orange-500 rounded-full shadow-lg shadow-orange-200"></div>
                            <h2 class="text-xl font-black text-slate-700 uppercase italic"></h2>
                        </div>
                        <div class="flex gap-2">
                                <input type="file" class="hidden" onchange="v12NeuralOCR(this)">
                            </label>
                            <button id="btnScanner" onclick="toggleScanner()" class="bg-slate-800 text-white px-7 py-5 rounded-lg text-[12px] font-black uppercase tracking-widest hover:bg-orange-800 transition-colors">
                                Bipar Nota Fiscal
                            </button>
                        </div>
                    </div>

                    <div id="reader"></div>

                    <div class="col-span-3 grid grid-cols-1 gap-6 p-6 bg-slate-400 rounded-2xl border border-slate-300 shadow-[10px_10px_40px_#070a11,-10px_-10px_40px_#111827]">
    
    <div class="flex flex-col gap-2">
        <label class="text-[11px] font-black text-orange-300/30 uppercase tracking-[0.2em] ml-2">Auto Financer</label>
        <div class="relative group">
            <input type="number" id="valorInput" oninput="calcFiscal()" 
                   class="w-full bg-slate-600 p-5 rounded-2xl text-3xl font-bold text-orange-400 
                          shadow-[inset_6px_6px_12px_#070a11,inset_-6px_-6px_12px_#111827] 
                          border-none outline-none focus:ring-2 focus:ring-orange-500/30 transition-all placeholder-slate-400" 
                   placeholder="0,00">
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-black">BRL</div>
        </div>
    </div>

    <div class="flex flex-col gap-2">
        
        <label class="text-[11px] font-White text-slate-100 uppercase tracking-[0.2em] ml-2">Destinar Fluxo</label>
        
        <select id="slotDestino" 
            
                class="w-full bg-slate-900 p-4 rounded-2xl text-white font-medium
                       shadow-[2px_3px_6px_#070a11,-3px_-3px_6px_#111827] 
                       border border-slate-200 outline-none focus:border-orange-100 appearance-none cursor-pointer">
            
            <optgroup label="üì• ENTRADAS (RECEITAS)" class="bg-slate-600 text-orange-400">
                <option value="receita_pix">üì• RECEBIMENTO PIX</option>
                <option value="receita_cartao">üì• RECEBIMENTO CART√ÉO</option>
            </optgroup>
            <optgroup label="üèóÔ∏è ESTRUTURA E EXPANS√ÉO" class="bg-slate-600 text-slate-400">
                <option value="obras">üèóÔ∏è OBRAS E REFORMA</option>
                <option value="energia">‚ö° ENERGIA / CONDOM√çNIO</option>
                <option value="manutencao">üõ†Ô∏è MANUTEN√á√ÉO / EQUIPAMENTOS</option>
                <option value="equipamentos">üõí COMPRA DE EQUIPAMENTOS</option>
            </optgroup>
            <optgroup label="üë• OPERACIONAL / PESSOAL" class="bg-slate-600 text-slate-400">
                <option value="pro_labore">üë§ PRO-LABORE (RETIRADA)</option>
                <option value="func">üë• PAGAMENTO FUNCION√ÅRIOS</option>
                <option value="taxas">üí∏ TAXAS / IMPOSTOS</option>
                <option value="servicos">üíº SERVI√áOS EM GERAL</option>
            </optgroup>
        </select>
    </div>

    <button onclick="emitir('A4')" 
            class="group relative mt-2 overflow-hidden bg-orange-200 p-4 rounded-2xl font-white text-white uppercase tracking-widest
                   shadow-[3px_3px_6px_#EDF1FE,-2px_-2px_7px_rgba(34,8,2,0.5)]
                   active:shadow-[inset_4px_4px_8px_#9a3412] active:translate-y-1 transition-all">
        <span class="relative z-10">Emitir Nota</span>
        
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:translate-x-full duration-1000 transition-transform"></div>
    </button>
</div>



                    
<div class="grid grid-cols-6 gap-8">




    
                        <div class="col-span-3">
                            <label class="text-[11px] font-white text-slate-400 uppercase mb-2 block tracking-widest">ID - (CPF/CNPJ)</label>
                            <input type="text" id="docInput" oninput="motorBusca(this.value)" class="input-tactical w-full text-slate-800 text-lg shadow-inner" placeholder="000.000.000-00">
                        </div>




                    
                        <div class="col-span-3">
                            <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">E-mail</label>
                            <input type="email" id="emailInput" class="input-tactical w-full text-slate-800" placeholder="contato@exemplo.com">
                        </div>

    

                        <div class="col-span-3">
                            <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">WhatsApp</label>
                            <input type="text" id="telInput" class="input-tactical w-full text-slate-800" placeholder="(00) 00000-0000">
                        </div>

    

                        <div class="col-span-6">
                            <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Raz√£o Social / Nome</label>
                            <input type="text" id="nomeInput" onblur="validarNomeSeguro(this)" class="input-tactical w-full bg-slate-50 text-slate-600 border-dashed" readonly placeholder="Aguardando valida√ß√£o...">
                        </div>


    

                        <div class="col-span-6">
                            <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Descri√ß√£o do Ativo / Itens Escaneados</label>
                            <textarea id="descInput" class="input-tactical w-full h-32 font-normal text-slate-600" placeholder="Os itens bipados aparecer√£o aqui automaticamente..."></textarea>
                        </div>
                    </div>                    
                </div>   


                
                <div class="terminal-log shadow-xl">
                    <div id="logContent" class="h-32 overflow-y-auto leading-relaxed">
                        > Sistema Inicializado...<br>
                    </div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-4 space-y-6">
                <div class="panel-3d p-8 border-t-8 border-orange-500">
                    <h3 class="text-[12px] font-black text-center text-slate-400 uppercase mb-8 tracking-[0.2em]">Detalhe Tribut√°rio</h3>
                    <div class="space-y-6 bg-orange-50/50 p-6 rounded-2xl border border-orange-100 shadow-inner">
                        <div class="flex justify-between items-center">
                            <span class="font-black text-slate-500 uppercase text-[11px]">CBS (FEDERAL) 0.9%:</span>
                            <span id="cbsVal" class="font-mono font-black text-slate-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-black text-slate-500 uppercase text-[11px]">IBS (EST/MUN) 0.1%:</span>
                            <span id="ibsVal" class="font-mono font-black text-slate-800">R$ 0,00</span>
                        </div>
                        <div class="border-t-2 border-orange-200/50 pt-6 flex justify-between items-center">
                            <span class="text-sm font-black text-slate-700 uppercase">Valor Total:</span>
                            <span id="liqVal" class="text-3xl font-black text-orange-600">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="mt-10 space-y-4">
                        <button onclick="emitir('A4')" class="btn-orange w-full text-white font-black py-5 rounded-2xl shadow-xl uppercase text-sm">Emitir DANFE (A4)</button>
                        <button onclick="executarPagamentoPOS()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg uppercase text-[10px]">Pagar via Antena Hardware</button>
                        <button onclick="emitir('TERMICO')" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg uppercase text-[10px]">Imp. T√©rmica / PDV M√≥vel</button>
                    </div>
                </div>
                
                <div class="panel-3d p-6 bg-slate-900 border-none">
                    <h3 class="text-[10px] font-black text-orange-500 uppercase mb-4 tracking-widest">Monitoramento</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-[10px] font-mono">
                            <span class="text-slate-400">GEO-POLITICA:</span>
                            <span class="text-orange-400 font-bold">HIGH</span>
                        </div>
                        <div class="terminal-log shadow-xl">
                    <div class="flex justify-between border-b border-white/5 pb-2 mb-3">
                        <span class="font-black text-[10px] uppercase tracking-[0.3em] text-orange-400">Gemini AI</span>
                        <span class="text-[10px] text-slate-500 font-mono">ihvh</span>
                    </div>
                        <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                            <div class="bg-orange-500 h-full w-[85%]"></div>
                        </div>
                        <p class="text-[9px] text-slate-500 italic"></p>
                    </div>
                        <div class="grid grid-cols-12 gap-6 mb-8 no-print">
    <div class="col-span-6 panel-3d p-6 border-l-8 border-blue-500">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">RBA</p>
        <h2 id="receita-display" class="text-3xl font-black text-slate-800">R$ 0,00</h2>
    </div>
    <div class="col-span-6 panel-3d p-6 border-l-8 border-emerald-500">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lucro L√≠quido</p>
        <h2 id="lucro-display" class="text-3xl font-black text-emerald-600">R$ 0,00</h2>
    </div>
</div>
                </div>
            </div>
        </main>
    </div>

     

    <div id="print-area" class="hidden"></div>

    
    <script><script>
// ==========================================
// N√öCLEO DE DADOS V12 (UNIFICADO)
// ==========================================
let v12_finance, v12_users;
const SERIAL_P2 = "PB1F252F75254";
const ACCESS_KEY = "20260112PB1F252F75254";

try {
    // Tenta carregar os dados com seguran√ßa
    v12_finance = JSON.parse(localStorage.getItem('v12_finance')) || { receita: 0, despesa: 0, invest: 0 };
    v12_users = JSON.parse(localStorage.getItem('v12_database')) || [
        { email: "admin@v12.com", pass: "ihvh2026", status: "AUTHORIZED", role: "ADMIN" }
    ];
    console.log("Database V12 carregada com sucesso.");
} catch (error) {
    console.error("Erro na Database V12: Resetando para o padr√£o.");
    v12_finance = { receita: 0, despesa: 0, invest: 0 };
    v12_users = [{ email: "admin@v12.com", pass: "ihvh2026", status: "AUTHORIZED", role: "ADMIN" }];
}

// Fun√ß√£o para salvar que evita o erro de 'n√£o salvou'
function salvarTudoV12() {
    localStorage.setItem('v12_database', JSON.stringify(v12_users));
    localStorage.setItem('v12_finance', JSON.stringify(v12_finance));
}

// Inicializa√ß√£o √∫nica para n√£o travar o logo
window.onload = function() {
    if (typeof capturarDadosRede === "function") capturarDadosRede();
    
    // Esconde o logo/tela de carregamento
    const loader = document.getElementById('loading-screen') || document.getElementById('logo');
    if (loader) loader.style.display = 'none';
    
    console.log("SENTINELA V12: Sistema Desbloqueado.");
};
</script>

    <script>
    
    // 3. Atualiza o painel financeiro (DRE) logo na entrada
    if (typeof updateDRE === "function") {
        updateDRE();
    }

    // 4. Se existir um logo/tela de carregamento, esconde aqui
    const loader = document.getElementById('loading-screen') || document.getElementById('logo');
    if (loader) {
        loader.style.display = 'none';
    }
};
            </script>

    <script>            
            // Verifica se j√° existe um admin e prepara a interface
            if(localStorage.getItem('v12_database')) {
                console.log("Base de dados local sincronizada.");
            }
        };
        
    </script>

<script>
        
let v12_users = JSON.parse(localStorage.getItem('v12_database')) || [
            { email: "admin@v12.com", pass: "ihvh2026", status: "AUTHORIZED", role: "ADMIN" }
        ];

</script>

    <script>

        function addLog(msg) {
            const log = document.getElementById('logContent');
            log.innerHTML += `> [${new Date().toLocaleTimeString()}] ${msg}<br>`;
            log.scrollTop = log.scrollHeight;
        }

    </script>

    <script>

        // --- 1. LOGIN ---
        function checkV12Auth() {
            const email = document.getElementById('v12_email').value;
            const pass = document.getElementById('v12_pass').value;
            const user = v12_users.find(u => u.email === email && u.pass === pass);

            if (user) {
                if (user.status === "AUTHORIZED") {
                    document.getElementById('auth-gate').style.display = 'none';
                    addLog(`BEM-VINDO: ${user.email.toUpperCase()}`);
                    
                    if (user.role === "ADMIN") {
                        document.getElementById('admin-panel').style.display = 'block';
                        atualizarPainelAdmin();
                    }
                } else {
                    alert("Acesso pendente de autoriza√ß√£o.");
                }
            } else {
                alert("Credenciais Inv√°lidas.");
            }
        }
</script>

    <script>
        // --- 2. CADASTRO ---
        function solicitarCadastro() {
            const email = prompt("E-mail do novo comando:");
            const pass = prompt("Chave Criptogr√°fica:");
            if (email && pass) {
                if (v12_users.find(u => u.email === email)) return alert("J√° existe!");
                v12_users.push({ email, pass, status: "PENDING", role: "OPERATOR" });
                localStorage.setItem('v12_database', JSON.stringify(v12_users));
                alert("Solicitado! Pe√ßa ao Admin para liberar.");
            }
        }
    </script>

    <script>
        // --- 3. PAINEL ADMIN ---
        function atualizarPainelAdmin() {
            const tabela = document.getElementById('user-list-table');
            if (!tabela) return;
            tabela.innerHTML = ''; 

            v12_users.forEach((user, index) => {
                if (user.role === "ADMIN") return;
                const corStatus = user.status === "AUTHORIZED" ? "text-green-400" : "text-yellow-500";
                
                tabela.innerHTML += `
                    <tr class="border-b border-slate-700">
                        <td class="py-3">${user.email}</td>
                        <td class="py-3 ${corStatus} font-bold">${user.status}</td>
                        <td class="py-3">
                            <button onclick="autorizarUser(${index})" class="bg-emerald-600 px-2 py-1 rounded text-white text-[10px] mr-1">LIBERAR</button>
                            <button onclick="removerUsuarioV12('${user.email}')" class="bg-red-600 px-2 py-1 rounded text-white text-[10px]">REMOVER</button>
                        </td>
                    </tr>`;
            });
        }

        function autorizarUser(index) {
            v12_users[index].status = "AUTHORIZED";
            localStorage.setItem('v12_database', JSON.stringify(v12_users));
            atualizarPainelAdmin();
            addLog(`OPERADOR ${v12_users[index].email} AUTORIZADO.`);
        }

        function removerUsuarioV12(email) {
            if (confirm("Remover permanentemente?")) {
                v12_users = v12_users.filter(u => u.email !== email);
                localStorage.setItem('v12_database', JSON.stringify(v12_users));
                atualizarPainelAdmin();
                addLog(`USU√ÅRIO REMOVIDO.`);
            }
        }
    </script>

    <script>
        // --- 4. FISCAL ---
        function calcFiscal() {
            const v = parseFloat(document.getElementById('valorInput').value) || 0;
            document.getElementById('cbsVal').innerText = `R$ ${(v * 0.009).toFixed(2)}`;
            document.getElementById('ibsVal').innerText = `R$ ${(v * 0.001).toFixed(2)}`;
            document.getElementById('liqVal').innerText = `R$ ${v.toFixed(2)}`;
        }
    </script>

<script>
    
    async function processarVenda() {
    const status = document.getElementById('status');
    status.innerText = "üöÄ PROCESSANDO DADOS V12...";

    try {
        const response = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                cpf: document.getElementById('cpf').value,
                v12_auth: "20260112PB1F252F75254" 
            })
        });

        const retorno = await response.json(); // Aqui pegamos os dados da AWS

        if (retorno.success || retorno.checkoutUrl) {
            status.innerText = "‚úÖ DADOS RECEBIDOS! GERANDO NOTA...";
            
            // ESTA √â A PARTE QUE FALTA: Enviar os dados para a nota
            gerarImpressao({
                tipo: 'A4', // ou 'TERMICO'
                nome: retorno.nome || "Cliente V12",
                doc: retorno.cpf || "000.000.000-00",
                dataHora: new Date().toLocaleString(),
                vTotal: parseFloat(retorno.valor) || 0,
                desc: "AUTORIZA√á√ÉO DE PAGAMENTO V12",
                receitaAcumulada: retorno.receita || 0,
                lucroAcumulado: retorno.lucro || 0,
                fed: retorno.impostoFed || 0,
                est: retorno.impostoEst || 0,
                ACCESS_KEY: "V12-AUTH-PROD",
                SP2: "SENTINELA-XP8",
                Code: Math.floor(Math.random() * 100000)
            });
        }
    } catch (err) {
        status.innerText = "‚ùå ERRO AO CONECTAR COM N√öCLEO.";
        console.error(err);
    }
}

    </script>
    
    <script>
       // 6. REMOVER USU√ÅRIO COM LOG DE AUDITORIA
function removerUsuarioV12(email) {
    // Evita que o admin se exclua por acidente
    const userAtual = v12_users.find(u => u.email === email);
    if (userAtual && userAtual.role === "ADMIN") {
        alert("ERRO CR√çTICO: N√£o √© poss√≠vel remover uma conta de ADMINISTRADOR.");
        return;
    }

    if (confirm(`CONFIRMAR EXCLUS√ÉO: ${email}?\nEsta a√ß√£o √© irrevers√≠vel no banco local.`)) {
        v12_users = v12_users.filter(u => u.email !== email);
        salvarEAtualizarV12();
        addLog(`USU√ÅRIO REMOVIDO: ${email}`);
    }
}

    </script>

    <script>
// 7. SALVAR E SINCRONIZAR DATABASE
function salvarEAtualizarV12() {
    try {
        localStorage.setItem('v12_database', JSON.stringify(v12_users));
        
        // Atualiza a interface se o painel existir
        if (typeof atualizarPainelAdmin === "function") {
            atualizarPainelAdmin();
        }
        
        // Feedback t√©cnico no terminal
        console.log("Database V12 Sincronizada.");
    } catch (e) {
        addLog("ERRO AO SALVAR: Mem√≥ria local cheia ou inacess√≠vel.");
    }
}
    </script>

    <script>
// 8. C√ÅLCULO FISCAL AVAN√áADO (Refletindo na DANFE e Painel)
function calcFiscal() {
    const valorRaw = document.getElementById('valorInput').value;
    const valor = parseFloat(valorRaw) || 0;
    
    // Regras tribut√°rias Sentinela V12
    const cbs = valor * 0.009; // Contribui√ß√£o sobre Bens e Servi√ßos
    const ibs = valor * 0.001; // Imposto sobre Bens e Servi√ßos
    const impostoTotal = cbs + ibs;

    // Atualiza√ß√£o din√¢mica dos elementos da interface
    const elementos = {
        'cbsVal': cbs,
        'ibsVal': ibs,
        'liqVal': valor
    };

    for (let [id, val] of Object.entries(elementos)) {
        const el = document.getElementById(id);
        if (el) {
            el.innerText = `R$ ${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            // Efeito visual de atualiza√ß√£o
            el.style.color = val > 0 ? "var(--active-orange)" : "inherit";
        }
    }
}

    </script>

    <script>
// 9. LIBERA√á√ÉO R√ÅPIDA DE OPERADOR
function liberarUsuario(email) {
    let userIndex = v12_users.findIndex(u => u.email === email);
    
    if (userIndex !== -1) {
        v12_users[userIndex].status = "AUTHORIZED";
        salvarEAtualizarV12();
        
        addLog(`AUTORIDADE CONCEDIDA: ${email.toUpperCase()}`);
        
        // Se estiver logado como admin, atualiza a tabela imediatamente
        if (document.getElementById('admin-panel')?.style.display === 'block') {
            atualizarPainelAdmin();
        }
    } else {
        addLog(`ERRO: Usu√°rio ${email} n√£o encontrado.`);
    }
}  


    </script>

    <script>
        
    let v12_finance = { receita: 0, despesa: 0, invest: 0 };
        
        // CORRE√á√ÉO: Fun√ß√£o de Login validando campos adicionados
        function checkV12Auth() {
            const email = document.getElementById('v12_email').value;
            const pass = document.getElementById('v12_pass').value;
            
            if(email.length > 5 && pass === "ihvh2026") {
                document.getElementById('auth-gate').style.display = 'none';
                addLog(`ACESSO AUTORIZADO: ${email.toUpperCase()}`);
                generateAIInsight("Sincroniza√ß√£o completa.");
            } else { 
                alert("ACESSO NEGADO: Verifique sua chave V12."); 
            }
        }
    </script>

    <script>
        
        function v12NeuralOCR(input) {
            addLog("IA: Processando documento...");
            setTimeout(() => {
                let val = Math.floor(Math.random() * 200) + 50;
                v12_finance.despesa += val;
                updateDRE();
                addLog(`DESPESA DETECTADA: R$ ${val},00`);
                generateAIInsight("Fluxo de sa√≠da detectado. IA correlacionando com movimenta√ß√µes de mercado.");
            }, 1000);
        }
    </script>

    <script>
        
        function updateDRE() {
            document.getElementById('dre_receita').innerText = `R$ ${v12_finance.receita.toFixed(2)}`;
            document.getElementById('dre_despesa').innerText = `R$ ${v12_finance.despesa.toFixed(2)}`;
            document.getElementById('dre_invest').innerText = `R$ ${v12_finance.invest.toFixed(2)}`;
        }
    </script>

    <script>
        
        let somaScanner = 0;
        let itensLidos = new Set();
        let html5QrCode = null;
        const SERIAL_P2 = "PB1F252F75254";
        const ACCESS_KEY = "20260112PB1F252F75254";

        async function capturarDadosRede() {
            addLog("Mapeando autoridade de Hardware...");
            setTimeout(() => {
                document.getElementById('network-badge').innerText = `P2: ${SERIAL_P2}`;
                document.getElementById('network-badge').className = "text-[9px] font-black bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded italic";
                addLog(`HARDWARE VALIDADO: Smart POS P2 [${SERIAL_P2}]`);
            }, 1000);
        }
    </script>

     <script>    
    // Tenta encontrar o ecr√£ de carregamento (logo) e escond√™-lo
    // Verifica se o teu HTML tem id="loading-screen" ou id="logo-overlay"
    const logo = document.getElementById('loading-screen') || document.getElementById('logo');
    
    if (logo) {
        logo.style.opacity = '0';
        setTimeout(() => { logo.style.display = 'none'; }, 500);
        console.log("Sistema Vis√≠vel.");
    } else {
        console.error("Erro: N√£o encontrei o ID do logo para apagar da tela.");
    }
};
    </script>

    <script>
        
        function executarPagamentoPOS() {
            const valor = document.getElementById('valorInput').value;
            if(!valor || valor == 0) return alert("Insira um valor.");
            v12_finance.receita += parseFloat(valor);
            updateDRE();
            addLog(`Invocando Hardware... R$ ${valor}`);
            generateAIInsight("Transa√ß√£o em curso via Antena P2. Registrando autoridade fiscal.");
            const intentUrl = `intent://pay?amount=${Math.round(valor*100)}&currency=BRL#Intent;scheme=infinitepay;package=com.infinitepay.checkout;S.browser_fallback_url=${window.location.href};end`;
            window.location.href = intentUrl;
        }

    </script>

    <script>

        async function toggleScanner() {
            const readerDiv = document.getElementById('reader');
            const btn = document.getElementById('btnScanner');
            if (!html5QrCode) { html5QrCode = new Html5Qrcode("reader"); }
            if (readerDiv.style.display === 'none' || readerDiv.style.display === '') {
                readerDiv.style.display = 'block';
                btn.innerText = "FECHAR C√ÇMERA (X)";
                await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (txt) => {
                    if (itensLidos.has(txt)) return;
                    itensLidos.add(txt);
                    let p = Math.floor(Math.random() * 50) + 10;
                    somaScanner += p;
                    document.getElementById('valorInput').value = somaScanner.toFixed(2);
                    document.getElementById('descInput').value += `Item [${txt}] - R$ ${p},00\n`;
                    calcFiscal();
                    generateAIInsight(`Item identificado: ${txt}. Integridade do ativo confirmada.`);
                });
            } else {
                await html5QrCode.stop();
                readerDiv.style.display = 'none';
                btn.innerText = "Bipar Produtos";
            }
        }
    </script>
        
    <script>
        
        function motorBusca(val) {
            const doc = val.replace(/\D/g, '');
            if (doc.length === 11 || doc.length === 14) {
                const nomeInput = document.getElementById('nomeInput');
                nomeInput.readOnly = false;
                nomeInput.focus();
                addLog("Identidade Liberada.");
            }
        }
    </script>

    <script>
        
        function calcFiscal() {
            const v = parseFloat(document.getElementById('valorInput').value) || 0;
            document.getElementById('cbsVal').innerText = `R$ ${(v * 0.009).toFixed(2)}`;
            document.getElementById('ibsVal').innerText = `R$ ${(v * 0.001).toFixed(2)}`;
            document.getElementById('liqVal').innerText = `R$ ${v.toFixed(2)}`;
        }
    </script>

    <script>
        
        function addLog(msg) {
            const log = document.getElementById('logContent');
            log.innerHTML += `> [${new Date().toLocaleTimeString()}] ${msg}<br>`;
            log.scrollTop = log.scrollHeight;
        }
    </script>

     <script>
        
    // 2. VALIDA√á√ÉO B√ÅSICA
    if (!nome || !valorInput) {
        alert("Erro: Preencha o Nome e o Valor Operacional.");
        return;
    }

    </script>

    <script>
        
                function updateDRE() {
    // 1. C√°lculos de base
    const receitaTotal = v12_finance.receita;
    const totalImpostos = receitaTotal * 0.01; // CBS (0.9%) + IBS (0.1%)
    const lucroLiquido = receitaTotal - totalImpostos;
    </script>

    <script>
    // 2. Atualiza√ß√£o dos Elementos Visuais (Cards de Destaque)
    // Procure ou crie elementos com esses IDs no seu HTML
    if (document.getElementById('receita-display')) {
        document.getElementById('receita-display').innerText = `R$ ${receitaTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    }

    </script>

    <script>
        
    if (document.getElementById('lucro-display')) {
        document.getElementById('lucro-display').innerText = `R$ ${lucroLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        // Se o lucro for positivo, brilha em verde. Se negativo, vermelho.
        document.getElementById('lucro-display').style.color = lucroLiquido >= 0 ? "#10b981" : "#ef4444";
    }

    // 3. Log de Auditoria Financeira
    console.log(`[DRE V12] Sincronizado: Receita R$ ${receitaTotal.toFixed(2)} | Lucro R$ ${lucroLiquido.toFixed(2)}`);
}

    
    // PROCESSAMENTO FINANCEIRO V12
    const vTotal = parseFloat(valorInput) || 0;
    const fed = vTotal * 0.1345; 
    const est = vTotal * 0.07;   
    const totalImpostosVenda = fed + est;
    const authCode = Math.floor(100000 + Math.random() * 900000);
    const dataHora = new Date().toLocaleString('pt-BR');

    // ATUALIZA√á√ÉO DO CAIXA (SISTEMA DE AUTORIDADE)
    v12_finance.receita += vTotal;
    const receitaAcumulada = v12_finance.receita;
    const lucroAcumulado = receitaAcumulada * 0.99; // Considerando taxa operacional V12

    // ATUALIZA INTERFACE VISUAL
    updateDRE();
        
    const dataHora = new Date().toLocaleString('pt-BR');
    const fed = vTotal * 0.1345; // Imposto Federal
    const est = vTotal * 0.07;   // Imposto Estadual
    const totalImpostosVenda = fed + est;
    const authCode = Math.floor(100000 + Math.random() * 900000);

    </script>

      <script>

    // 3. ATUALIZA√á√ÉO DO FINANCEIRO (DRE)
    v12_finance.receita += vTotal;
    const receitaAcumulada = v12_finance.receita;
    const lucroAcumulado = receitaAcumulada * 0.99;

    <script>
        
async function finalizarAgoraV12() {
    const btn = document.querySelector('button');
    btn.innerText = "IA PROCESSANDO...";

    const dadosReal = {
        cpf: document.getElementById('cpf').value,
        cep: document.getElementById('cep').value,
        valor: "12450.00", // Valor real do sistema
        nome: "CLIENTE V12"
    };

    try {
        const response = await fetch('https://mxkyrbqcwpcoqkhshtqjrfonvu0dwchv.lambda-url.sa-east-1.on.aws/', {
            method: 'POST',
            body: JSON.stringify(dadosReal)
        });

        const res = await response.json();
        
        // Se a ponte com a Pagaleve funcionar, ele redireciona sozinho
        if (res.url) {
            window.location.href = res.url;
        } else {
            alert("Erro na gera√ß√£o do Link Real.");
        }
    } catch (err) {
        console.error("Erro de Conex√£o:", err);
    }
}
</script>



<script>
        async function enviarParaV12() {
            const status = document.getElementById('status');
            const cpf = document.getElementById('cpf').value;
            const cep = document.getElementById('cep').value;

            if(cpf.length < 14) { alert("CPF incompleto"); return; }

            status.innerText = "‚ö° DROPPFY IA: PROCESSANDO NA REDE...";
            
            try {
                // Link oficial da sua Lambda (visto no print image_970b0b.png)
                const URL_LAMBDA = 'https://4djefisdvvgqv4jl3j5x35mssi0vxfmv.lambda-url.sa-east-1.on.aws/';
                
                const response = await fetch(URL_LAMBDA, {
                    method: 'POST',
                    mode: 'no-cors', // Importante para evitar erro de conex√£o simples
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cpf, cep, token: "01KF10NWVS30NQGHEJ99SFSBCS" })
                });

                status.innerText = "‚úÖ SOLICITA√á√ÉO ENVIADA COM SUCESSO!";
                setTimeout(() => {
                    window.location.href = "https://loja.infinitepay.io/droppfy";
                }, 1500);

            } catch (err) {
                status.innerText = "‚ùå ERRO DE CONEX√ÉO. VERIFIQUE A LAMBDA.";
                console.error(err);
            }
        }
    </script>





  <script>
        function emitir(tipo) {
    const vTotal = parseFloat(document.getElementById('valorInput').value) || 0;
    const slot = document.getElementById('slotDestino').value;

    if (vTotal <= 0) return alert("ERRO: Valor de autoridade n√£o definido.");

    // Garante que a estrutura detalhada existe
    if (!v12_finance.detalhado) v12_finance.detalhado = {};

    // DIRECCIONAMENTO
    if (slot.startsWith('receita')) {
        v12_finance.receita += vTotal;
    } else {
        v12_finance.despesa += vTotal;
        // Alimenta o slot espec√≠fico (ex: obras)
        v12_finance.detalhado[slot] = (v12_finance.detalhado[slot] || 0) + vTotal;
    }

    // Persist√™ncia
    salvarTudoV12();
    if (typeof updateDRE === "function") updateDRE();

    // Com o slot definido, a nota fiscal agora sai detalhada
    gerarNotaV12(tipo, vTotal, slot);
}
    <script>
    // 5. COMANDOS DE FINALIZA√á√ÉO
    salvarEAtualizarV12(); // Salva no banco
    updateDRE();           // Atualiza o painel na tela
    addLog(`EMISS√ÉO REALIZADA: R$ ${vTotal.toFixed(2)} - ${nome}`);
    
    // Dispara a impress√£o
    window.print();
}

      </script>  
    
<script>
    addLog(`DRE INTEGRADO: Documento #${authCode} | Receita Dia: R$ ${receitaAcumulada.toFixed(2)}`);
    window.print();
}

 </script>

    <script>
        
        function validarNomeSeguro(el) {
            if(el.value.length > 0 && el.value.trim().split(' ').length < 2) {
                alert("NOME COMPLETO REQUERIDO.");
                el.focus();
            }
        }
</script>

    <script>
        // NOVO: Fun√ß√£o para gerar Insights din√¢micos da IA
        function generateAIInsight(text) {
            const aiDisplay = document.getElementById('ai-insight');
            aiDisplay.innerText = text;
            addLog(`SENTINELA ANAL√çTICO: ${text}`);
        }
    </script>
</body>
</html>
